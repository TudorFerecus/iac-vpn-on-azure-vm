# â˜ï¸ Azure WireGuard VPN - Infrastructure as Code

This project provides a complete **Infrastructure as Code (IaC)** solution to deploy your own private WireGuard VPN server on Microsoft Azure.

It uses **Terraform** to provision the cloud infrastructure (Virtual Machine, Networking, Firewall, DNS) and **Ansible** to automate the configuration (Docker, WireGuard container, Nginx Reverse Proxy, and SSL).

---

## â‰ï¸ Why do I need this?

It's simple: good VPNs are rarely free, and free VPNs are rarely good.

This solution works best for **Students** because Azure offers a generous grant (about $100 in credit), but it is a great fit for anyone with Azure credits or a small budget.

The student credit often isn't enough to cover Azure's managed "VPN Gateway" service for a full year. However, it is more than enough to run a small, cheap 1-core VM (Standard B-series). This project allows you to build your own VPN on that affordable VM, with the added bonus that you can use the remaining resources for other projects.

If you are a student or a hobbyist, this is a fun, practical way to get a private VPN while learning DevOps skills (Terraform, Ansible, Docker).

## ğŸ“‚ Project Structure

```text
.
â”œâ”€â”€ Ansible
â”‚   â”œâ”€â”€ group_vars
â”‚   â”‚   â””â”€â”€ vpn_server.yml      # Configuration: Password hash, Domain name, DNS toggle
â”‚   â”œâ”€â”€ inventory.ini           # Auto-generated by Terraform (do not edit manually)
â”‚   â”œâ”€â”€ site.yml                # Main Playbook
â”‚   â””â”€â”€ ansible.cfg             # Ansible configuration (prevents SSH host key errors)
â”œâ”€â”€ Scripts
â”‚   â”œâ”€â”€ gen_hash.py             # Helper script to generate secure password hashes
â”‚   â””â”€â”€ vpn_connect_disconnect.sh # Helper script to easily connect/disconnect on Linux
â”œâ”€â”€ Terraform
â”‚   â”œâ”€â”€ main.tf                 # Azure infrastructure definition
â”‚   â”œâ”€â”€ inventory.tftpl         # Template for the Ansible inventory
â”‚   â”œâ”€â”€ terraform.tfvars        # (Optional) Personal variables (API Keys, Regions)
â”‚   â”œâ”€â”€ variables.tf            # Variable declarations
â”‚   â””â”€â”€ ...
â””â”€â”€ README.md

```

## ğŸ› ï¸ Prerequisites

Ensure you have the following installed on your local machine:
* **Azure CLI** (`az`)
* **Terraform**
* **Ansible**
* **Python 3** (for the helper scripts)
* **SSH Key Pair**: If you don't have one, generate it: `ssh-keygen -t rsa -f ~/.ssh/vpn_vm_key`

## ğŸŒ Optional Prerequisites (for HTTPS/DNS)

If you want your VPN Web UI to have a custom domain (e.g., vpn.yourdomain.com) with valid SSL certificates:

* **Cloudflare Account**: You need an API Token with DNS editing permissions.

* **Domain Name**: A domain managed by Cloudflare.

---

# ğŸš€ Setup & Configuration Guide

## Step 1: Azure Authentication

Before running any code, you must authenticate with Azure and retrieve
your Subscription ID.

1.  Open your terminal and log in:

``` bash
az login
```

2.  Once logged in, list your accounts to find your **Subscription ID**:

``` bash
az account list --output table
```

Copy the `SubscriptionId`. You will need this for Terraform.

------------------------------------------------------------------------

## Step 2: Provision Infrastructure (Terraform)

1.  Navigate to the Terraform directory:

``` bash
cd Terraform
```

2.  **Configure Variables**: Create a file named `terraform.tfvars` to define your settings. This keeps your secrets safe and separate from the code.
``` bash
subscription_id  = "YOUR-AZURE-SUB-ID"
private_key_path = "~/.ssh/vpn_vm_key"
location         = "eastus" # Recommended for Students
vm_user          = "adminuser"

# --- Optional: Cloudflare DNS & SSL ---
# Only set these if you want a custom domain + HTTPS
create_dns_record = true
cloudflare_api    = "YOUR-CLOUDFLARE-TOKEN"
zone_id           = "YOUR-CLOUDFLARE-ZONE-ID"
dns_name          = "vpn" # Subdomain (e.g., vpn.tudorferecus.ro)
```

3.  **Initialize** and **apply** the configuration:

``` bash
terraform init
terraform apply
```

(Type **yes** when prompted).

4.  **Result**: Terraform will create the VM, firewall rules, and automatically generate the `Ansible/inventory.ini` file for you.

------------------------------------------------------------------------

## Step 3: Configure VPN & Web UI (Ansible)

### 1. Generate a Secure Password Hash

WireGuard Easy requires a specific hash format for the Web UI password.
Run the provided helper script:

``` bash
python3 Scripts/gen_hash.py
```

Copy the resulting hash output in Ansible/group_vars/vpn_server.yml

### 2. Update Inventory

Navigate to `Ansible/group_vars/vpn_server.yml`. This is where you configure the application logic.

* **Paste you password hash** into web_password.
* **Optional** if you enabled Cloudflare in Terraform, set `enable_dns: true` and add your full domain.

**Example** `vpn_server.yml`:

``` bash
enable_dns: true  # Set to false if you are NOT using a domain
domain_name: vpn.yourdomain.com
web_password: '$2b$12$...' # Your generated hash
```

### 3. Run the Playbook:

``` bash
cd ../Ansible
ansible-playbook -i inventory.ini vpn_wg_docker.yml
```

Ansible will connect to the server, install Docker, setup WireGuard, and (if enabled) configure Nginx and Let's Encrypt SSL.

------------------------------------------------------------------------

# ğŸ–¥ï¸ Managing Clients (Web UI)

Once Ansible finishes, the VPN server is running inside a Docker
container.

1.  **Access the UI:**
    * **HTTPS (if DNS enabled):** https://vpn.yourdomain.com
    * **HTTP (IP only):** http://<YOUR_SERVER_IP>:51821
2.  Log in with the password you set (the plain text version, not the
    hash).
3.  Click **"New Client"** to create users (e.g., `Laptop`, `Phone`).
4.  **For Mobile:** Click the QR code icon and scan it with the
    WireGuard app.
5.  **For Desktop:** Click the Download icon to save the `.conf` file
    (save it to the `Configs/` folder).

------------------------------------------------------------------------

# ğŸ§ Connecting to the VPN (Linux)

You can use the standard `wg-quick` command, or the provided helper
script for a smoother experience.

### Using the Helper Script:

``` bash
# To Connect
./Scripts/vpn_connect_disconnnect.sh ./Configs/Tudor.conf connect

# To Disconnect
./Scripts/vpn_connect_disconnnect.sh ./Configs/Tudor.conf disconnect
```

------------------------------------------------------------------------

### ğŸ§ Important Note for Linux Users (`resolvconf` error)

If you are using a distribution like **Arch Linux** or others where you manage DNS manually, you might encounter this error when connecting:
`resolvconf: signature mismatch: /etc/resolv.conf`

**The Fix:**
1.  Open your downloaded `.conf` file (e.g., `Configs/Tudor.conf`).
2.  Find the line starting with `DNS = ...`.
3.  **Comment it out** by adding a `#` at the start:
    ```ini
    [Interface]
    ...
    # DNS = 1.1.1.1
    ```
4.  Save and try connecting again.

*Note: This prevents the VPN from overwriting your local DNS settings, avoiding the conflict.*

# âš ï¸ Important Notes for Student Subscriptions

1. Provider Registration: The Terraform config includes `skip_provider_registration = true` to prevent permission errors common with Azure for Students.

2. Regions: Free/Student accounts are often restricted in popular regions like westeurope. If deployment fails with a "Policy" or "Quota" error, try US regions (`eastus`).

# ğŸ”® Roadmap / Future Updates

* [x] Docker Support: Replaced bare-metal installation with wg-easy Docker container for Web UI management.

* [x] Dynamic Inventory: Configure Terraform to automatically generate the inventory.ini file with the correct IP and other variables.

* [x] HTTPS: Add SSL certificates (Let's Encrypt) for the Web UI.

* [ ] Security Hardening: Restrict SSH access in the Network Security Group (NSG) to allow connections only from your specific home IP address.


# ğŸ› ï¸ Flowchart

Down below is the flowchart of how this all works

``` mermaid
flowchart TD
    classDef userNode fill:#dcfce7,stroke:#166534,stroke-width:2px,color:#14532d;
    classDef cloudService fill:#eff6ff,stroke:#1d4ed8,stroke-width:2px,color:#1e3a8a;
    classDef securityNode fill:#fff7ed,stroke:#ea580c,stroke-width:2px,color:#9a3412;
    classDef computeNode fill:#f3e8ff,stroke:#7e22ce,stroke-width:2px,color:#581c87;
    classDef containerNode fill:#e0f2fe,stroke:#0284c7,stroke-width:2px,color:#0c4a6e;
    classDef storageNode fill:#fef9c3,stroke:#ca8a04,stroke-width:2px,color:#854d0e;
    
    User([ğŸ’» User / Phone]):::userNode
    
    subgraph External_Services [ğŸŒ Internet & DNS]
        direction TB
        style External_Services fill:#fafafa,stroke:#e5e7eb,stroke-dasharray: 5 5
        CF(â˜ï¸ Cloudflare DNS):::cloudService
    end

    subgraph Azure_Cloud [â˜ï¸ Microsoft Azure Region]
        direction TB
        style Azure_Cloud fill:#f0f9ff,stroke:#0ea5e9,stroke-width:2px
        
        subgraph Resource_Group [ğŸ“¦ Resource Group: dev-vpn-rg]
            style Resource_Group fill:#ffffff,stroke:#94a3b8,stroke-width:1px
            
            IP(ğŸŒ Public IP):::cloudService
            NSG{ğŸ›¡ï¸ NSG Firewall}:::securityNode
            NIC(ğŸ”Œ Network Interface):::cloudService

            subgraph VNet [Virtual Network: 10.0.0.0/16]
                style VNet fill:#f8fafc,stroke:#cbd5e1,stroke-dasharray: 3 3
                
                subgraph Subnet [Subnet: 10.0.2.0/24]
                    style Subnet fill:#ffffff,stroke:#e2e8f0
                    
                    subgraph VM_Box [ğŸ–¥ï¸ VM: dev-vm]
                        style VM_Box fill:#f5f3ff,stroke:#8b5cf6,stroke-width:2px
                        
                        subgraph Docker_Engine [ğŸ³ Docker Engine]
                            style Docker_Engine fill:#ffffff,stroke:#38bdf8,stroke-dasharray: 2 2
                            
                            WG[âš¡ WireGuard Container]:::containerNode
                            NGINX[Tb Nginx Proxy]:::containerNode
                        end
                        
                        FILES[(ğŸ“‚ Config Files\n/opt/wireguard)]:::storageNode
                    end
                end
            end
        end
    end
    
    User -.-o|DNS Request| CF
    CF -.->|A Record IP| User
    
    User ==>|VPN Tunnel UDP/51820| IP
    User -->|HTTPS TCP/443| IP
    
    IP --> NSG
    NSG -->|Allow Rules| NIC
    NIC --> VM_Box
    
    WG <-->|Internal Network| NGINX
    NGINX -->|Proxy Pass :51821| WG
    FILES -.-o|Volume Mount| WG

    linkStyle default stroke:#64748b,stroke-width:1px;
```
